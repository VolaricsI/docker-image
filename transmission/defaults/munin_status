#!/usr/bin/env python3

import sys
import os
from transmission_rpc import Client
from collections import Counter

client = Client()

def get_status_counts():
    torrents = client.get_torrents()
    statuses = [t.status for t in torrents]
    return Counter(statuses)

def print_config():
    category = os.getenv("MUNIN_CATEGORIA", "network")
    print("graph_title Transmission torrent státuszok")
    print("graph_vlabel torrentek száma")
    print(f"graph_category {category}")
    print("graph_args --base 1000 -l 0")
    for status in ['stopped', 'downloading', 'seeding', 'checking', 'queued']:
        print(f"{status}.label {status}")
        print(f"{status}.type GAUGE")

def print_values():
    counts = get_status_counts()
    for status in ['stopped', 'downloading', 'seeding', 'checking', 'queued']:
        print(f"{status}.value {counts.get(status, 0)}")

if __name__ == "__main__":
    if len(sys.argv) > 1 and sys.argv[1] == "config":
        print_config()
    else:
        print_values()
